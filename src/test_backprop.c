/* automatically generated by 'generate_test.py' */
void test_back_propagation()
{
    Network network = make_network(2, 3, 4);

    // fill network
    network.w1[0 * 2 + 0 * 1] = 0.4900934100151062;
    network.w1[0 * 2 + 1 * 1] = 0.8964447379112244;
    network.w1[1 * 2 + 0 * 1] = 0.455627977848053;
    network.w1[1 * 2 + 1 * 1] = 0.6323062777519226;
    network.w1[2 * 2 + 0 * 1] = 0.3488934636116028;
    network.w1[2 * 2 + 1 * 1] = 0.40171730518341064;
    network.w2[0 * 3 + 0 * 1] = 0.022325754165649414;
    network.w2[0 * 3 + 1 * 1] = 0.16885894536972046;
    network.w2[0 * 3 + 2 * 1] = 0.2938884496688843;
    network.w2[1 * 3 + 0 * 1] = 0.518521785736084;
    network.w2[1 * 3 + 1 * 1] = 0.6976675987243652;
    network.w2[1 * 3 + 2 * 1] = 0.800011396408081;
    network.w2[2 * 3 + 0 * 1] = 0.16102945804595947;
    network.w2[2 * 3 + 1 * 1] = 0.28226858377456665;
    network.w2[2 * 3 + 2 * 1] = 0.6816085577011108;
    network.w2[3 * 3 + 0 * 1] = 0.9151939749717712;
    network.w2[3 * 3 + 1 * 1] = 0.39709991216659546;
    network.w2[3 * 3 + 2 * 1] = 0.8741558790206909;
    network.b1[0 * 1] = 0.41940832138061523;
    network.b1[1 * 1] = 0.5529070496559143;
    network.b1[2 * 1] = 0.9527381062507629;
    network.b2[0 * 1] = 0.036164820194244385;
    network.b2[1 * 1] = 0.1852310299873352;
    network.b2[2 * 1] = 0.37341737747192383;
    network.b2[3 * 1] = 0.3051000237464905;

    // fill gradients
    double *nabla_w1 = malloc(6 * sizeof(double));
    nabla_w1[0 * 2 + 0 * 1] = 0.013823913410305977;
    nabla_w1[0 * 2 + 1 * 1] = 0.021399881690740585;
    nabla_w1[1 * 2 + 0 * 1] = 0.019749242812395096;
    nabla_w1[1 * 2 + 1 * 1] = 0.03057248890399933;
    nabla_w1[2 * 2 + 0 * 1] = 0.02851865626871586;
    nabla_w1[2 * 2 + 1 * 1] = 0.044147834181785583;
    double *nabla_b1 = malloc(3 * sizeof(double));
    nabla_b1[0 * 1] = 0.027856383472681046;
    nabla_b1[1 * 1] = 0.039796434342861176;
    nabla_b1[2 * 1] = 0.05746756121516228;
    double *nabla_w2 = malloc(12 * sizeof(double));
    nabla_w2[0 * 3 + 0 * 1] = 0.19593028724193573;
    nabla_w2[0 * 3 + 1 * 1] = 0.19235506653785706;
    nabla_w2[0 * 3 + 2 * 1] = 0.19920076429843903;
    nabla_w2[1 * 3 + 0 * 1] = 0.14140258729457855;
    nabla_w2[1 * 3 + 1 * 1] = 0.13882236182689667;
    nabla_w2[1 * 3 + 2 * 1] = 0.14376288652420044;
    nabla_w2[2 * 3 + 0 * 1] = 0.12867256999015808;
    nabla_w2[2 * 3 + 1 * 1] = 0.1263246238231659;
    nabla_w2[2 * 3 + 2 * 1] = 0.1308203786611557;
    nabla_w2[3 * 3 + 0 * 1] = 0.04046597331762314;
    nabla_w2[3 * 3 + 1 * 1] = 0.03972757235169411;
    nabla_w2[3 * 3 + 2 * 1] = 0.041141435503959656;
    double *nabla_b2 = malloc(4 * sizeof(double));
    nabla_b2[0 * 1] = 0.24665787816047668;
    nabla_b2[1 * 1] = 0.17801262438297272;
    nabla_b2[2 * 1] = 0.16198670864105225;
    nabla_b2[3 * 1] = 0.05094287171959877;

    // fill inputs and label
    double *inputs = malloc(2 * sizeof(double));
    inputs[0 * 1] = 0.49625658988952637;
    inputs[1 * 1] = 0.7682217955589294;
    double *label = malloc(4 * sizeof(double));
    label[0 * 1] = 0.08847743272781372;
    label[1 * 1] = 0.13203048706054688;
    label[2 * 1] = 0.30742281675338745;
    label[3 * 1] = 0.6340786814689636;

    // run backprop
    double *nabla_w[] = {
        malloc(network.s0 * network.s1 * sizeof(double)),
        malloc(network.s1 * network.s2 * sizeof(double)),
    };
    double *nabla_b[] = {
        malloc(network.s1 * sizeof(double)),
        malloc(network.s2 * sizeof(double)),
    };
    double loss = back_propagation(network, inputs, label, nabla_w, nabla_b);

    // compare loss
    assert_scalar("loss", 1.078608512878418, loss);

    // compare gradients
    assert_array("nabla_w1", 6, nabla_w1, nabla_w[0]);
    assert_array("nabla_b1", 3, nabla_b1, nabla_b[0]);
    assert_array("nabla_w2", 12, nabla_w2, nabla_w[1]);
    assert_array("nabla_b2", 4, nabla_b2, nabla_b[1]);

    // free gradients
    free(nabla_w1);
    free(nabla_b1);
    free(nabla_w2);
    free(nabla_b2);
    free(nabla_w[0]);
    free(nabla_w[1]);
    free(nabla_b[0]);
    free(nabla_b[1]);
    // free inputs and labels
    free(inputs);
    free(label);
}
